{% extends "base.html" %}

{% block title %}Policies - Whale Wallet{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">Policy Engine</h1>
        <p class="page-subtitle">Configure transaction rules and security policies</p>
    </div>
    <button class="btn btn-primary" onclick="Modal.open('new-policy-modal')">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19" />
            <line x1="5" y1="12" x2="19" y2="12" />
        </svg>
        Add Policy
    </button>
</div>

<!-- Policy Stats -->
<div class="grid grid-4 mb-xl">
    <div class="card">
        <p class="stat-label">Active Policies</p>
        <p class="stat-value text-success">4</p>
    </div>
    <div class="card">
        <p class="stat-label">Transactions Blocked</p>
        <p class="stat-value text-warning">12</p>
        <p class="text-sm text-muted mt-sm">Last 30 days</p>
    </div>
    <div class="card">
        <p class="stat-label">Whitelisted Addresses</p>
        <p class="stat-value">5</p>
    </div>
    <div class="card">
        <p class="stat-label">Daily Limit Used</p>
        <p class="stat-value">$2,450</p>
        <p class="text-sm text-muted mt-sm">of $10,000</p>
    </div>
</div>

<!-- Active Policies -->
<h3 class="mb-lg">Active Policies</h3>
<div class="flex flex-col gap-md mb-xl">
    <!-- Velocity Limit -->
    <div class="card">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-lg">
                <div
                    style="width: 56px; height: 56px; background: rgba(16, 185, 129, 0.15); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                    ‚è±
                </div>
                <div>
                    <h4>Daily Velocity Limit</h4>
                    <p class="text-secondary">Maximum $10,000 USD per 24-hour rolling window</p>
                    <div class="flex gap-md mt-sm">
                        <span class="badge badge-primary">Velocity</span>
                        <span class="text-sm text-muted">Created Jan 1, 2026</span>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-md">
                <span class="badge badge-success">Active</span>
                <button class="btn btn-ghost btn-icon" onclick="editPolicy('velocity')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Whitelist -->
    <div class="card">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-lg">
                <div
                    style="width: 56px; height: 56px; background: rgba(59, 130, 246, 0.15); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                    ‚úì
                </div>
                <div>
                    <h4>Whitelist Only</h4>
                    <p class="text-secondary">Only allow transactions to pre-approved addresses</p>
                    <div class="flex gap-md mt-sm">
                        <span class="badge badge-info">Whitelist</span>
                        <span class="text-sm text-muted">5 addresses ‚Ä¢ Created Jan 5, 2026</span>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-md">
                <span class="badge badge-success">Active</span>
                <button class="btn btn-ghost btn-icon" onclick="editPolicy('whitelist')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Time Lock -->
    <div class="card">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-lg">
                <div
                    style="width: 56px; height: 56px; background: rgba(245, 158, 11, 0.15); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                    üîí
                </div>
                <div>
                    <h4>Large Transaction Time Lock</h4>
                    <p class="text-secondary">24-hour delay for transactions exceeding $50,000</p>
                    <div class="flex gap-md mt-sm">
                        <span class="badge badge-warning">Time Lock</span>
                        <span class="text-sm text-muted">Created Jan 10, 2026</span>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-md">
                <span class="badge badge-success">Active</span>
                <button class="btn btn-ghost btn-icon" onclick="editPolicy('timelock')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Contract Interaction -->
    <div class="card">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-lg">
                <div
                    style="width: 56px; height: 56px; background: rgba(130, 71, 229, 0.15); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                    üìú
                </div>
                <div>
                    <h4>Smart Contract Verification</h4>
                    <p class="text-secondary">Block interactions with unverified or flagged contracts</p>
                    <div class="flex gap-md mt-sm">
                        <span class="badge"
                            style="background: rgba(130, 71, 229, 0.15); color: #8b5cf6;">Contract</span>
                        <span class="text-sm text-muted">Blowfish integration ‚Ä¢ Created Jan 12, 2026</span>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-md">
                <span class="badge badge-success">Active</span>
                <button class="btn btn-ghost btn-icon" onclick="editPolicy('contract')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                    </svg>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Whitelisted Addresses -->
<h3 class="mb-lg">Whitelisted Addresses</h3>
<div class="card mb-xl">
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>Label</th>
                    <th>Address</th>
                    <th>Chain</th>
                    <th>Added</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Coinbase Hot Wallet</td>
                    <td class="mono">0x71C7656EC7ab88b098defB751B7401B5f6d8976F</td>
                    <td><span class="chain-badge"><span>‚ß´</span> Ethereum</span></td>
                    <td class="text-muted">Jan 5, 2026</td>
                    <td>
                        <button class="btn btn-ghost btn-sm text-error"
                            onclick="removeWhitelist('0x71C7...')">Remove</button>
                    </td>
                </tr>
                <tr>
                    <td>Personal Ledger</td>
                    <td class="mono">0x8894E0a0c962CB723c1976a4421c95949bE2D4E3</td>
                    <td><span class="chain-badge"><span>‚ß´</span> Ethereum</span></td>
                    <td class="text-muted">Jan 6, 2026</td>
                    <td>
                        <button class="btn btn-ghost btn-sm text-error"
                            onclick="removeWhitelist('0x8894...')">Remove</button>
                    </td>
                </tr>
                <tr>
                    <td>Kraken</td>
                    <td class="mono">bc1q84vlu8hswvxl0jqx3e0yxvj0m9x09w2k5k7f7w</td>
                    <td><span class="chain-badge"><span>‚Çø</span> Bitcoin</span></td>
                    <td class="text-muted">Jan 8, 2026</td>
                    <td>
                        <button class="btn btn-ghost btn-sm text-error"
                            onclick="removeWhitelist('bc1q84...')">Remove</button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    <button class="btn btn-secondary mt-lg" onclick="Modal.open('add-address-modal')">
        + Add Address
    </button>
</div>

<!-- Policy Simulator -->
<h3 class="mb-lg">Policy Simulator</h3>
<div class="card">
    <p class="text-secondary mb-lg">Test how policies would evaluate a hypothetical transaction</p>
    <form id="simulator-form" onsubmit="simulatePolicy(event)">
        <div class="grid grid-3 mb-lg">
            <div class="form-group">
                <label class="form-label">Chain</label>
                <select class="form-input form-select" id="sim-chain">
                    <option value="ethereum">Ethereum</option>
                    <option value="bitcoin">Bitcoin</option>
                    <option value="solana">Solana</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">To Address</label>
                <input type="text" class="form-input mono" id="sim-to" placeholder="0x...">
            </div>
            <div class="form-group">
                <label class="form-label">Value (USD)</label>
                <input type="number" class="form-input" id="sim-value" placeholder="5000">
            </div>
        </div>
        <button type="submit" class="btn btn-secondary">Evaluate Policies</button>
    </form>

    <div id="sim-result" class="mt-lg" style="display: none;">
        <div class="card" style="background: rgba(16, 185, 129, 0.1); border-color: var(--color-success);">
            <div class="flex items-center gap-md">
                <span style="font-size: 2rem;">‚úÖ</span>
                <div>
                    <h4 class="text-success">Transaction Allowed</h4>
                    <p class="text-secondary">All policies passed. This transaction would be approved.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Policy Modal -->
<div class="modal-overlay" id="new-policy-modal">
    <div class="modal">
        <div class="modal-header">
            <h3>Add Policy</h3>
            <button class="modal-close" onclick="Modal.close('new-policy-modal')">√ó</button>
        </div>

        <form id="policy-form" onsubmit="createPolicy(event)">
            <div class="form-group">
                <label class="form-label">Policy Name</label>
                <input type="text" class="form-input" id="policy-name" placeholder="e.g., Weekend Limit" required>
            </div>

            <div class="form-group">
                <label class="form-label">Policy Type</label>
                <select class="form-input form-select" id="policy-type" required>
                    <option value="">Select type...</option>
                    <option value="velocity_limit">Velocity Limit</option>
                    <option value="whitelist">Whitelist Only</option>
                    <option value="time_lock">Time Lock</option>
                    <option value="time_window">Time Window</option>
                    <option value="chain_restriction">Chain Restriction</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Configuration (JSON)</label>
                <textarea class="form-input form-textarea mono" id="policy-config"
                    placeholder='{"max_value_usd": 10000, "window_hours": 24}'></textarea>
            </div>

            <div class="flex gap-md">
                <button type="button" class="btn btn-secondary" style="flex: 1;"
                    onclick="Modal.close('new-policy-modal')">
                    Cancel
                </button>
                <button type="submit" class="btn btn-primary" style="flex: 1;">
                    Create Policy
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Add Address Modal -->
<div class="modal-overlay" id="add-address-modal">
    <div class="modal">
        <div class="modal-header">
            <h3>Add Whitelisted Address</h3>
            <button class="modal-close" onclick="Modal.close('add-address-modal')">√ó</button>
        </div>

        <form onsubmit="addWhitelistAddress(event)">
            <div class="form-group">
                <label class="form-label">Label</label>
                <input type="text" class="form-input" placeholder="e.g., My Ledger" required>
            </div>

            <div class="form-group">
                <label class="form-label">Chain</label>
                <select class="form-input form-select" required>
                    <option value="ethereum">Ethereum</option>
                    <option value="bitcoin">Bitcoin</option>
                    <option value="solana">Solana</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Address</label>
                <input type="text" class="form-input mono" placeholder="0x..." required>
            </div>

            <div class="flex gap-md">
                <button type="button" class="btn btn-secondary" style="flex: 1;"
                    onclick="Modal.close('add-address-modal')">
                    Cancel
                </button>
                <button type="submit" class="btn btn-primary" style="flex: 1;">
                    Add Address
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function editPolicy(type) {
        WhaleWallet.Toast.info('Opening policy editor...');
    }

    function removeWhitelist(address) {
        if (confirm('Remove this address from whitelist?')) {
            WhaleWallet.Toast.success('Address removed');
        }
    }

    function simulatePolicy(event) {
        event.preventDefault();
        document.getElementById('sim-result').style.display = 'block';
        WhaleWallet.Toast.success('Policy simulation complete');
    }

    function createPolicy(event) {
        event.preventDefault();
        WhaleWallet.Toast.success('Policy created successfully');
        Modal.close('new-policy-modal');
    }

    function addWhitelistAddress(event) {
        event.preventDefault();
        WhaleWallet.Toast.success('Address added to whitelist');
        Modal.close('add-address-modal');
    }
</script>
{% endblock %}